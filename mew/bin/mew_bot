#!/usr/bin/env mew_js
!function(){let e=module.filename;e||(e=module.id);const t=require("\x66s"),n=require("path"),s=require("vm"),i=require("module"),o=/[\\\/]+/g,r=Object.create(null),x=Object.create(null),c=Object.create(null),a=Object.create(null);["child_process","cluster","console","crypto","debugger","dgram","dns","domain","events","\x66s","http","http2","https","inspector","module","net","os","path","per\x66_hooks","process","punycode","querystring","readline","repl","stream","string_decoder","timers","tls","trace_events","tty","url","util","vm","v8","zlib","worker_threads","assert","bu\x66\x66er","constants","mew_util","mewchan"].forEach(e=>{a[e]=!0});const p=function(e){return e.replace(o,"\x2f")},h=function(e){return/^([a-z]:)?[\\\/]/gim.test(e)},l=function(e,t){return t=p(t),e=p(e),t.slice(0,e.length+1)===e+"\x2f"},d=function(s,o){if(o=n.normalize(o),l(e,o)){let t=p(n.relative(e,o));for(let e of["","\x2ejs","\x2ejson"])if(c[t+e])return o+e}else for(let e of[""].concat(Object.keys(i._extensions))){let n=o+e;if(t.existsSync(n)&&t.statSync(n).isFile())return t.realpathSync(n)}},u=function(s,i){let o=void 0;if(l(e,i)){const t=p(n.relative(e,i));if(c[t+"\x2fpackage\x2ejson"]){try{o=y(i+"\x2fpackage\x2ejson").main}catch(e){}o&&(o=n.normalize(n.join(i,o)))}}else if(t.existsSync(i+"\x2fpackage\x2ejson")){try{o=JSON.parse(t.readFileSync(i+"\x2fpackage\x2ejson").toString("ut\x668")).main}catch(e){}o&&(o=n.normalize(n.join(i,mainJS)))}if(o){let e=d(0,o);if(e)return e}let r=d(0,i+"\x2finde\x78");if(r)return r},f=function(t,s){let i=t.filename;if(i||(i=t.id),(s=0===s.length?t?i:e:/^\.(\.?)[\/\\]/.test(s)?i===e?n.normalize(n.join(i,s)):n.normalize(n.join(i,"\x2e\x2e",s)):n.normalize(s))===e||!h(e)&&l(e,s))return s;n.basename(s);let o=function(e,t){if(a[t])return t}(0,s);return o||(h(s)?(o=d(0,s))||u(0,s):function(e,t){for(let s of e.paths){let e=d(0,n.join(s,t));if(e)return e;if(e=u(0,n.join(s,t)))return e}}(t,s))};let b=t.readFile,m=t.readFileSync;const g=new Proxy(t,{get:function(s,i,o){return"readFile"===i?function(s){let i=void 0,o=void 0;switch(arguments.length){case 2:o=arguments[1];break;case 3:i=arguments[1],o=arguments[2]}if(h(s)||(s=n.join(process.cwd(),s)),!l(e,s))return b.apply(t,arguments);let r=p(n.relative(e,s)),c=x[r];void 0!==c?(i&&"string"==typeof i?c=c.toString(i):i&&i.encoding&&(c=c.toString(i.encoding)),process.nextTick(()=>o(void 0,c))):process.nextTick(()=>o(new Error("File\x20not\x20\x66ound")))}:"readFileSync"===i?function(t,s){if(h(t)||(t=n.join(process.cwd(),t)),!l(e,t))return m(t);let i=p(n.relative(e,t)),o=x[i];if(void 0===o)throw new Error("File\x20not\x20\x66ound");return s&&"string"==typeof s?o=o.toString(s):s&&s.encoding&&(o=o.toString(s.encoding)),o}:t[i]}}),y=function(t){if("\x66s"===t)return g;const o=t;if(!(t=f(module,t)))throw new Error(`Module[${JSON.stringify(o)}]\x20not\x20\x66ound`);if(!l(e,t))return i.prototype.require.call(module,t);let x=p(n.relative(e,t)),a=(n.basename(x),n.extname(x));if("\x2ejs"!==a&&"\x2ejson"!==a)throw new Error("Unsupported\x20module\x20e\x78tension\x20in\x20combined\x20script");let h=r[x];if(h)return h.exports;if(!c[x])throw new Error("File\x20not\x20\x66ound");let d={require:function(e){let t=f(d,e);if(t)return y(t);throw new Error("Can't\x20\x66ind\x20module\x20"+e)}};d.require.extensions=i._extensions,d.require.main=process.mainModule,d.require.resolve=function(e){return f(d,e)},d.exports={},d.paths=i._nodeModulePaths(n.dirname(t)),d.filename=t,d.module=d,r[x]=d;let u=0,b=c[x].toString();return"\x66unction\x20\x28module\x2c\x20e\x78ports\x2c\x20require\x2c\x20__dirname\x2c\x20__\x66ilename\x2c\x20__e\x78ports\x29\x20{"!=b.split(/\r|\n|\r\n/)[0]||(u=2),b=`\x28${b}\x29\x28module\x2c\x20e\x78ports\x2c\x20require\x2c\x20__dirname\x2c\x20__\x66ilename\x2c\x20e\x78ports\x29`,s.runInThisContext(i.wrap(b),{filename:t,lineOffset:u,displayErrors:!0}).call(d.exports,d.exports,d.require,d,t,n.dirname(t)),d.exports};c["inde\x78\x2ejs"]=function(e,t,n,s,i,o){@.process.mode="customized",n("\x2e\x2fannot\x2ejs");const{switchesRules:r,abbreviations:x}=n("\x2e\x2fhelp\x2ejs"),c=@.process.switches(r,x);if("help"===c.mode)return@.task.printHelp(r,x),void process.exit(0);if("version"===c.mode||c.settings.version)return@.process.print("mew_bot\x20version\x203\x2e\x30\x2e\x30"),void process.exit(0);if(c.settings.buildPath||(c.settings.buildPath=@path("build")),c.settings.help)n("\x2e\x2fcmd\x2fhelp\x2ejs").command(c).rejected(function(e){@error(e),process.exit(1)});else switch(c.mode){case"brush":n("\x2e\x2fcmd\x2fbrush\x2ejs").command(c).rejected(function(e){@error(e),process.exit(1)});break;case"check":n("\x2e\x2fcmd\x2fcheck\x2ejs").command(c).rejected(function(e){@error(e),process.exit(1)});break;case"list":n("\x2e\x2fcmd\x2flist\x2ejs").command(c).rejected(function(e){@error(e),process.exit(1)});break;case"start":default:n("\x2e\x2fcmd\x2fe\x78ec\x2ejs").command(c).rejected(function(e){@error(e),process.exit(1)})}t!==o&&(e.exports=t)},c["annot\x2ejs"]=function(e,t,n,s,i,o){@import("js\x2eannot");const r=n("\x2e\x2fbot\x2ejs"),x=n("\x2e\x2fbrush\x2ejs");@annot.func("mew\x2ebot","bot\x2econd\x2ebuild",function(e,t,n){return r.createConditionalBuild(e,t,n)}),@annot.func("mew\x2ebot","bot\x2econd\x2edist",function(e,t,n){return r.createConditionalDist(e,t,n)}),@annot.func("mew\x2ebot","bot\x2econd\x2edeps",function(e,t,n){return r.createConditionalDependencies(e,t,n)}),@annot.func("mew\x2ebot","bot\x2edep\x2ehndl",function(e,t,n){return r.registerDependencyHandler(e,t,n)}),@annot.func("mew\x2ebot","bot\x2ebrush\x2erepo",function(e){x.registerRepoBrush(e.from,e.to)}),@annot.func("mew\x2ebot","bot\x2ebrush\x2ere\x66ish",function(e){x.registerRefishBrush(e.repo,e.from,e.to)}),@annot.func("mew\x2ebot","bot\x2ebrush\x2edep",function(e){e.registerDepBrush(e)}),@annot.func("mew\x2ebot","bot\x2ebrush\x2ecmd",function(e,t){1===arguments.length?x.registerCommandBrush(e):x.registerCommandBrush(e,t)}),t!==o&&(e.exports=t)},c["bot\x2ejs"]=function(e,t,n,s,i,o){const r=n("url"),x=n("\x2e\x2fproc\x2ejs"),c=n("\x2e\x2fbrush\x2ejs"),a=Object.create(null),p=Object.create(null),h=Object.create(null);h.OLDPWD=!0,h.PWD=!0,h.SHLVL=!0,h._=!0,h.TERM_PROGRAM=!0,h.TERM_PROGRAM_VERSION=!0,h.TERM_SESSION_ID=!0,h.SSH_AUTH_SOCK=!0,h.SSH_AGENT_PID=!0,h.SECURITYSESSIONID=!0,h.WINDOWID=!0,h.GDMSESSION=!0,h.GNOME_DESKTOP_SESSION_ID=!0,h.SESSION_MANAGER=!0,h.DBUS_SESSION_BUG_ADDRESS=!0;let l=!1;const d=Object.create(null),u=function(e,t){let n=[];if(@.fs.exists.file(e,"\x2ebotignore"))try{let t={};@.fs.readFile.sync(@path(e,"\x2ebotignore")).toString("ut\x668").split("\n").forEach(e=>{(e=e.trim())&&"\x23"!==e[0]&&(t[e]=!0)});for(let e in t)n.push(@.as(e,"rege\x78\x2dpath"))}catch(e){@warn("Failed\x20to\x20load\x20bot\x20ignore\x20\x66ile"),@warn(e)}else n.push(@.as("\x2f\x2f\x2e\x2a","rege\x78\x2dpath")),n.push(@.as("build","rege\x78\x2dpath")),n.push(@.as("dist","rege\x78\x2dpath"));let s={},i=Object.create(null);if(!t&&@.fs.exists.file(@path(e,"build","bot\x2dcache\x2ejson")))try{let t=@.fs.readFile.sync(@path(e,"build","bot\x2dcache\x2ejson"),"json");for(let e in t)i[e]=t[e]}catch(e){@warn("Failed\x20to\x20load\x20bot\x20hash\x20caches"),@warn(e)}let o=!1;return@.fs.scanFiles(e,1/0,t=>{let s=@.fs.rootBasedPath(e,t.path);if("\x2e"===s)return!0;for(let e of n)if(e.test(s))return!1;return"dir"===t.type||"link"===t.type&&@.fs.fileStats(t.path).type,!0}).then(function(t){t=t.filter(e=>"\x66ile"===e.type||"link"===e.type&&"\x66ile"===@.fs.fileStats(e.path).type),@.async.all(t,function(t){let n=t;"link"===t.type&&(n=@.fs.fileStats(t.path));let r=@.fs.rootBasedPath(e,t.path);if(i[r]&&i[r].modifyTime===n.modifyTime.getTime())return s[r]=i[r].sha1,void this.next();@.fs.hash.sha1(t.path).then(function(e){s[r]=e,o=!0,i[r]={modifyTime:n.modifyTime.getTime(),sha1:e},this.next()}).pipe(this)}).pipe(this)}).then(function(){if(t)return void this.next();if(!o)return void this.next();let n=@path(e,"build","bot\x2dcache\x2ejson");@.fs.makeDirs(@.fs.dirname(n)),@.fs.writeFile(n,JSON.stringify(i,null,4)).pipe(this)}).resolve(s)},f=function MewBot(e,t,s,i,o){this.name=e,this.variants=t,this.cwd=@realpath(s),this.env={};for(let e of Object.keys(i).sort())this.env[e]=i[e];for(let e in h)delete this.env[e];this.options=o,this.options||(this.options={}),this.buildPath=this.options.buildPath,this.buildPath||(this.buildPath=@path(this.cwd,"build")),function(e){if(e)return void(l&&@warn("Global\x20brushes\x20has\x20already\x20been\x20loaded"));if(l)return;l=!0,@debug("Loading\x20global\x20brushes");let t=@.fs.homePath("\x2emew\x2fbot\x2fbrushes");if(!@.fs.exists.dir(t))return;let s=@.fs.listFiles(t);for(let e of s)if("\x2ejs"===@.fs.extname(e.name)&&"\x2e"!==e.name[0]){let s=@path(t,e.name);if(!d[s]){d[s]=!0,@debug(`Loading\x20global\x20brush[${s}]`);try{n(s)}catch(e){@error(`Failed\x20to\x20load\x20global\x20brush[${s}]`),@error(e)}}}}(o.noGlobalBrush),this.loadBrushes(o.brushes),this.ready=this.reload()};f.prototype.built=!1,f.functors={},f.prototype.loadBrushes=function(e){if(!e){let t=@path(this.cwd,"bot\x2fbrushes");e=@.fs.exists.dir(t)?@.fs.listFiles(t).map(e=>@path(t,e.name)):[]}for(let t of e){let e=@path(this.cwd,t);if(!d[e]){d[e]=!0,@debug(`Loading\x20brush[${e}]`);try{n(e)}catch(t){@error(`Failed\x20to\x20load\x20global\x20brush[${e}]`),@error(t)}}}},f.prototype.generateSignature=function(e){if(this.resolved.signature&&!e)return this.resolved.signature;const t=this;let n={name:this.name,variants:this.variants,env:this.env,hash:this.hash,deps:{},files:{}};return this.resolved.signature=this.ready.then(function(){t.resolved.dependencies.pipe(this)}).then(function(t,s){let i=Object.create(null);const o=function(e){if(!i[e]){i[e]=s[e];for(let t in i[e].deps)o(i[e].deps[t])}};for(let e in t)o(t[e]);@.async.all(Object.keys(i),function(t){let i=s[t];n.deps[t]={deps:i.deps,noBot:i.noBot,config:i.config},n.deps[t].noBot?u(i.path,!0).then(function(e){n.deps[t].hash=@.hash.sha1(JSON.stringify({deps:{},files:e})),this.next()}).pipe(this):i.bot.generateSignature(e).then(function(e,s){n.deps[t].hash=s,this.next()}).pipe(this)}).pipe(this)}).then(function(){u(t.cwd).then(function(e){n.files=e,this.next()}).pipe(this)}).then(function(){let e=@.hash.sha1(JSON.stringify(n));this.next(n,e)}),this.resolved.signature},f.prototype.checkSignature=function(e){const t=this;let n=this.resolveSignaturePath();return@.async(function(){@.fs.exists.file(n)?@.fs.readFile(n).then(function(n){let{signature:s,hash:i}=JSON.parse(n.toString("ut\x668"));t.generateSignature(e).then(function(e,t){i===t?this.next(!1,t):this.next(!0,t)}).pipe(this)}).pipe(this):t.generateSignature(e).then(function(e,t){this.next(!0,t)}).pipe(this)})},f.prototype.reload=function(){return@.lock(this.cwd+"\x2fbuild_"+this.name+"\x2elck",()=>{let e=@path(this.cwd,"bot",this.name+"\x2ejs");this.hash=@.hash.sha1(@.fs.readFile.sync(e).toString("ut\x668")),this.config=n(e),this.functors=Object.assign({},f.functors),this.config.functors&&Object.assign(this.functors,this.config.functors),this.lastResolved=this.resolved,this.resolved={};let t=this.resolveVariants(!0);this.variants=Object.assign({},t),this.dependencies=Object.create(null);let s=this;this.resolved.dependencies=this.resolveDependencies(this.config.deps,t,this.cwd,this.env,this.options.caches),this.resolved.dependencies.then(function(e,t){for(let n in e)s.dependencies[n]=t[e[n]].config;this.next()}),this.built=!1})},f.prototype.lock=function(e,t){const n=this;let s=()=>{let t=[@path(this.cwd,"repo\x2erwlck")],s=e=>e.ready.then(function(){e.resolved.dependencies.pipe(this)}).then(function(n,i){@.async.all(Object.keys(n),function(o){let r=i[n[o]],x=r.config.repo;if(p[x]){let n=@path(e.resolveDependencyRepoPath(r.config),"repo\x2erwlck");-1===t.indexOf(n)&&t.push(n)}let c=@path(r.path,"repo\x2erwlck");-1===t.indexOf(c)?(t.push(c),r.bot?s(r.bot).pipe(this):this.next()):this.next()}).pipe(this)});return s(n).then(function(){let n=function(s){return s<t.length?@.lock.read(t[s],()=>n(s+1)):e()};n(0).pipe(this)})};return t?s():@.lock(this.cwd+"\x2fbuild_"+this.name+"\x2elck",s)},f.prototype.buildDependency=function(e,t,n,s,i){return@.async(function(){let t=i[e];t.noBot||t.config.noBuild?this.next():t.bot.buildWithDependencies(t.deps,i,{}).pipe(this)})},f.prototype.buildDependencies=function(e,t){const n=this;return Object.keys(e).length>0&&@info(`Building\x20dependencies\x20o\x66\x20bot[${n.name}@${@.fs.filename(n.cwd)}]:\x20\n\x20\x20${Object.keys(e).map(t=>t+":\x20"+e[t]).join("\n\x20\x20")}`),@.async.all(Object.keys(e),function(s){const i=e[s],o=t[i];o.noBot||o.config.noBuild?this.next():n.buildDependency(i,o.bot.variants,o.bot.cwd,o.bot.env,t).pipe(this)})},f.prototype.buildWithDependencies=function(e,t,n){return this.lock(()=>this.buildWithDependenciesNoLock(e,t,n))},f.prototype.buildWithDependenciesNoLock=function(e,t,n){const s=this;return@.async(function(){n.noCache?this.next(!0):s.checkSignature().pipe(this)}).then(function(i){if(!i)return@celebr(`Succeeded\x20to\x20build\x20bot[${s.name}@${@.fs.filename(s.cwd)}]\x2c\x20cache\x20available`),void this.next();s.buildDependencies(e,t).then(function(){@.fs.makeDirs(s.resolveBuildPath()),s.buildWithoutDependencies(n).pipe(this)}).then(function(){s.generateSignature().then(function(e,t){let n=s.resolveSignaturePath();@.fs.makeDirs(@.fs.dirname(n)),@.fs.writeFile(n,JSON.stringify({signature:e,hash:t},null,4)).pipe(this)}).pipe(this)}).pipe(this)})},f.prototype.buildWithoutDependencies=function(e){const t=this;return@.async(function(){@debug(`Building\x20bot[${t.name}@${@.fs.filename(t.cwd)}]`),@.fs.makeDirs(@path(t.cwd,"dist")),t.resolveBuild(t.config.build,t.variants,t.cwd,t.env).pipe(this)}).then(function(){@debug(`Constructing\x20distributions\x20o\x66\x20bot[${t.name}@${@.fs.filename(t.cwd)}]`),t.resolveDist(t.config.dists,t.variants,t.cwd,t.env).pipe(this)}).then(function(){@celebr(`Succeeded\x20to\x20build\x20bot[${t.name}@${@.fs.filename(t.cwd)}]`),this.next()})},f.prototype.resolveConfig=function(e,t){if(@.is.nil(e))return e;switch(typeof e){case"string":return"\x21\x24{"===e.slice(0,3)?@.format.tmpl(e.slice(3,-1),t,{bot:this,functors:this.functors}):@.format(e,t,{bot:this,functors:this.functors});case"object":if(e instanceof Array){let n=[];for(let s of e){let e=this.resolveConfig(s,t);"\x20\x21\x24{"===s.slice(0,3)&&e instanceof Array?n=n.concat(e):n.push(e)}return n}if(e instanceof Async||e instanceof Promise)return e;{let n={};for(let s in e){let i=this.resolveConfig(s,t),o=this.resolveConfig(e[s],t);n[i]=o}return n}case"boolean":case"number":case"\x66unction":default:return e}},f.prototype.resolveVariants=function(e){return this.resolved.variants&&!e||(this.resolved.variants=@.merge.advanced(this.config.vars,this.variants)),this.resolved.variants},f.prototype.resolveDependencies=function(e,t,n,s,i){i||(i=Object.create(null)),e=this.resolveConfig(e,t);const o=this;let r=Object.create(null),x=[];return@.async(function(){e?@.async.all(Object.keys(e),function(a){let p=e[a];if("string"==typeof p&&(p={repo:p}),"\x66unction"==typeof p)return void p.call(o,t,n,s).then(function(e){if(e){for(let t in e){let n=e[t];"string"==typeof n&&(n={repo:n}),n=@.merge(n),c.brushDep(n);let s=o.resolveDependencyID(n);r[t]=s,i[s]||(i[s]={config:n,deps:{}},x.push(s))}this.next()}else this.next()}).pipe(this);p=@.merge(p),c.brushDep(p);let h=o.resolveDependencyID(p);r[a]=h,i[h]||(i[h]={config:p,deps:{}},x.push(h)),this.next()}).pipe(this):this.next()}).all(x,function(e){const r=i[e];let x=[];for(let e in a)a[e].tester.call(o,r.config,t,n,s)&&x.push(a[e]);if(0==x.length)throw new Error(`Repository[${r.config.repo}]\x20handler\x20not\x20\x66ound`);x.length>1&&r.config.handler&&-1!==x.indexOf(a[r.config.handler])&&(x=[a[r.config.handler]]),x.length>1&&@warn(`Multiple\x20repository[${r.config.repo}]\x20handlers\x20has\x20been\x20\x66ound\x2c\x20please\x20speci\x66y\x20handler\x20o\x66\x20it\x20in\x20bot\x20\x66ile`),r.sync=function(e,i,c){return x[0].syncer.call(o,r.config,t,n,s,p,void 0,e,i,c)},r.sync(void 0,o.options.noSync).then(function(t,n,x){if(r.path=t,r.noBot=!(!n&&!r.config.noBot),r.noBot)return void this.next();let c=r.config.bot;if(!c&&(c="de\x66ault",!@.fs.exists.file(t,"bot",c+"\x2ejs")))return i[e].noBot=!0,void this.next();let a={};o.options&&(a=Object.assign(a,{cachePath:o.options.cachePath,buildPath:o.buildPath,noCache:o.options.noCache,noSync:o.options.noSync,caches:o.options.caches})),a.repo=r.config.repo;let p={};r.config.vars&&(p=Object.assign(p,r.config.vars));let h=new f(c,p,t,s,a);h.ready.then(function(){i[e].bot=h,h.config.deps?h.resolveDependencies(h.config.deps,h.variants,h.cwd,h.env,i).then(function(t){i[e].deps=Object.assign(i[e].deps,t),this.next()}).resolve(x).pipe(this):this.next()}).pipe(this)}).pipe(this)}).resolve(r,i)},f.prototype.resolveBuild=function(e,t,n,s){if(!e)return@.async.resolve();const i=this;return t=Object.assign({},t,{cwd:n}),@.async.all(e,function(e){let n=i.resolveConfig(e,t);if(c.brushCommand(n),"\x66unction"==typeof n)return void@.async(function(){@.async.ensure(n.call(i,t,t.cwd,s)).pipe(this)}).pipe(this);"string"==typeof n&&(n=n.trim().split(/\s+/));let o=[],r=Object.assign({},s),a=!1;for(let e of n)if(a||-1===e.indexOf("="))a=!0,o.push(e);else{let n=e.split("=")[0],s=e.split("=").slice(1).join("=");"CWD"===n?t=Object.assign({},t,{cwd:@path(t.cwd,s)}):(@info(`ENV:\x20${n}=${s}`),r[n]=s)}let p=@.as(@.process.switches().settings.pipeInternalOutput,"boolean"),h=-1!==["mew_js","mew","mew_chan","mew_doc","mew_test","mew_bot","mew_cc","chan","hako"].indexOf(o[0]);if(h){let e={};for(let t of process.argv){let n=t.split("=")[0];switch(n){case"\x2d\x2ddebug":case"\x2d\x2dlog\x2dlevel":case"\x2d\x2dlog\x2drecord\x2d\x66ile\x2dline":case"\x2d\x2dlog\x2dstyle":case"\x2d\x2dpipe\x2dinternal\x2doutput":e[n]=t}}let t=!1;for(let n of o.slice(1))if("\x2d"===n&&(t=!0),!t){let t=n.split("=")[0];switch(t){case"\x2d\x2ddebug":case"\x2d\x2dlog\x2dlevel":case"\x2d\x2dlog\x2drecord\x2d\x66ile\x2dline":case"\x2d\x2dlog\x2dstyle":case"\x2d\x2dpipe\x2dinternal\x2doutput":delete e[t]}}o.splice.apply(o,[1,0].concat(Object.keys(e).map(t=>e[t])))}if("mew_bot"===o[0]){let e=!1,t={"\x2d\x2dno\x2dsync":"\x2d\x2dno\x2dsync=yes","\x2d\x2dno\x2dcache":"\x2d\x2dno\x2dcache=yes"};i.options.cachePath&&(t["\x2d\x2dcache\x2dpath"]="\x2d\x2dcache\x2dpath="+i.options.cachePath);for(let n of o.slice(1))if("\x2d"===n&&(e=!0),!e){let e=n.split("=")[0];switch(e){case"\x2d\x2dcache\x2dpath":case"\x2d\x2dno\x2dsync":delete t[e]}}o.splice.apply(o,[1,0].concat(Object.keys(t).map(e=>t[e])))}let l=n.map(e=>e.replace(/[ \\'"\$&\|\{\}\(\)\>]/g,e=>"\\"+e)).map(e=>@.os.is.windows()&&"\x2f"===e[0]?"\x2f"+e:e);l.length>2?@info(`E\x78ecute:\x20CWD=${t.cwd}\n\x20\x20${l.join("\x20\\\n\x20\x20\x20\x20")}`):@info(`E\x78ecute:\x20CWD=${t.cwd}\n\x20\x20${l.join("\x20")}`),"cd"===o[0]?(t=Object.assign({},t,{cwd:@path(t.cwd,o[1])}),this.next()):x.spawnProcess(o[0],o.slice(1),t.cwd,r,(e,t)=>{(h||p)&&process[e].write(t)}).pipe(this)})},f.prototype.resolveDist=function(e,t,n,s){const i=this;return t=Object.assign({},t,{cwd:n}),e?@.async.all(Object.keys(e),function(o){let r=e[o];if(!(o=o.split("\x21")[0]))return void@.async(function(){@.async.ensure(r.call(i,t,n,s)).pipe(this)}).pipe(this);let x=r.split("\x2f\x2f")[0].split("\x2a")[0]===r,c=i.resolveConfig("\x21\x24{\x66iles\x28'"+r.replace(/'/g,"\\'")+"'\x29}",t),a=@path(n,r.split("\x2f\x2f")[0].split("\x2a")[0].split("\x2f").slice(0,-1).join("\x2f")),p=@path(i.resolveDistPath(),o);@.async.all(c,function(e){let t=@.fs.rootBasedPath(a,e),n=x?p:@path(p,t);@info(`Copy\x20${t}`),@.fs.makeDirs(@.fs.dirname(n)),@.fs.copyFile(e,n).pipe(this)}).pipe(this)}):@.async.resolve()},f.prototype.resolveDependencyID=function(e){if(!e){let e=this.options.repo,t=void 0;t=e?r.parse(e):r.pathToFileURL(this.cwd);let n={name:this.name,repo:e,vars:this.variants};return`${@.fs.basename(t.pathname)}\x2d${this.name}\x2d${("\x30\x30\x30\x30\x30\x30\x30\x30\x30"+@.hash(n).toString(16)).slice(-7)}`}let t=e.repo,n=r.parse(t),s=e.bot?e.bot:"de\x66ault";return`${@.fs.basename(n.pathname)}\x2d${s}\x2d${("\x30\x30\x30\x30\x30\x30\x30\x30\x30"+@.hash({name:s,repo:t,vars:e.vars?e.vars:{}}).toString(16)).slice(-7)}`},f.prototype.resolveDependencyRepoID=function(e){return@.fs.basename(e.repo)+"\x2d"+("\x30\x30\x30\x30\x30\x30\x30\x30\x30"+@.hash(e.repo).toString(16)).slice(-7)},f.prototype.resolveDependencyRepoPath=function(e){return this.options&&this.options.cachePath?@path(this.options.cachePath,"repos",this.resolveDependencyRepoID(e)):@path(this.buildPath,"bot\x2drepo\x2e"+this.resolveDependencyRepoID(e))},f.prototype.resolveDependencyPath=function(e){return e?this.options&&this.options.cachePath?@path(this.options.cachePath,"deps",this.resolveDependencyID(e)):@path(this.buildPath,"bot\x2ddep\x2e"+this.resolveDependencyID(e)):this.cwd},f.prototype.resolveBuildPath=function(e){return e?@path(this.resolveDependencyPath(e),"build"):@path(this.cwd,"build")},f.prototype.resolveDistPath=function(e){return@path(this.resolveDependencyPath(e),"dist")},f.prototype.resolveSignaturePath=function(){return@path(this.cwd,"build","bot\x2dsign\x2ejson")},f.prototype.getBuildPath=function(e,t,n){if(n||(n=this.cwd),!e){let e=this.resolveBuildPath();return t&&(e=@path(e,t)),@.fs.rootBasedPath(n,e)}if(!this.config.deps)throw new Error(`Dependency[${e}]\x20not\x20\x66ound`);let s=this.dependencies[e];if(!s)throw new Error(`Dependency[${e}]\x20not\x20\x66ound`);let i=this.resolveBuildPath(s);return t&&(i=@path(i,t)),@.fs.rootBasedPath(n,i)},f.prototype.getDepPath=function(e,t,n){if(n||(n=this.cwd),!this.config.deps)throw new Error(`Dependency[${e}]\x20not\x20\x66ound`);let s=this.dependencies[e];if(!s)throw new Error(`Dependency[${e}]\x20not\x20\x66ound`);let i=this.resolveDependencyPath(s);return t&&(i=@path(i,t)),@.fs.rootBasedPath(n,i)},f.prototype.getDistPath=function(e,t,n){if(n||(n=this.cwd),!e){let e=this.resolveDistPath();return t&&(e=@path(e,t)),@.fs.rootBasedPath(n,e)}if(!this.config.deps)throw new Error(`Dependency[${e}]\x20not\x20\x66ound`);let s=this.dependencies[e];if(!s)throw new Error(`Dependency[${e}]\x20not\x20\x66ound`);let i=this.resolveDistPath(s);return t&&(i=@path(i,t)),@.fs.rootBasedPath(n,i)};f.functors.files=function(e,t,n,s,i){if("\x2f"!==i[0]&&(i="\x2f"+i),-1===(i=n.cwd+i).indexOf("\x2f\x2f")&&-1===i.indexOf("\x2a"))return[i];let o=i.split("\x2f\x2f")[0];-1!==o.indexOf("\x2a")&&(o=o.split("\x2a")[0].split("\x2f").slice(0,-1).join("\x2f"));let r=@.as(i,"rege\x78\x2dpath");return@.fs.scanFiles.sync(o,1/0,e=>"dir"===e.type||"link"===e.type&&"dir"===@.fs.fileStats(e.path).type||r.test(e.path)).filter(e=>r.test(e.path)).map(e=>e.path)},f.functors.getBuildPath=function(e,t,n,s,i,o){return s.bot.getBuildPath(i,o,n.cwd)},f.functors.getDepPath=function(e,t,n,s,i,o){return i?s.bot.getDepPath(i,o,n.cwd):o?@path(s.bot.cwd,o):s.bot.cwd},f.functors.getDistPath=function(e,t,n,s,i,o){return s.bot.getDistPath(i,o,n.cwd)},a.bot=n("\x2e\x2fdep\x2fbot\x2ejs"),a.file=n("\x2e\x2fdep\x2f\x66ile\x2ejs"),a.git=n("\x2e\x2fdep\x2fgit\x2ejs"),a.json=n("\x2e\x2fdep\x2fjson\x2ejs"),e.exports.MewBot=f,e.exports.listRepos=function(){let e={};return@.async.all(Object.keys(p),function(t){if("dep:"!==r.parse(t).protocol&&"\x66ile:"!==r.parse(t).protocol){switch(e[t]={uri:t,localPath:p[t].localPath,lastTried:@.async.time(p[t])},@.async.state(p[t])){case 0:e[t].state="synchronizing";break;case 1:e[t].state="synchronized",e[t].lastSynchronized=@.async.result(p[t])[3];break;case-1:e[t].state="\x66ailed";break;default:e[t].state="unknown"}e[t].lastSynchronized||(e[t].lastSynchronized=p[t].lastSynchronized),this.next()}else this.next()}).then(function(){let t={};for(let n of Object.keys(e).sort())t[n]=e[n];this.next(t)})},e.exports.createConditionalBuild=function(e,t,n){if("string"==typeof e){let t=e;e=function(e,n,s){return@.format.tmpl(t,e,{})}}return function(s,i,o){return e(s,i,o)?this.resolveBuild(t,s,i,o):n?this.resolveBuild(n,s,i,o):@.async.resolve()}},e.exports.createConditionalDist=function(e,t,n){if("string"==typeof e){let t=e;e=function(e,n,s){return@.format.tmpl(t,e,{})}}return function(s,i,o){return e(s,i,o)?this.resolveDist(t,s,i,o):n?this.resolveDist(n,s,i,o):@.async.resolve()}},e.exports.createConditionalDependencies=function(e,t,n){if("string"==typeof e){let t=e;e=function(e,n,s){return@.format.tmpl(t,e,{})}}return function(s,i,o){return e(s,i,o)?@.async.resolve(t):n?@.async.resolve(n):@.async.resolve()}},e.exports.registerDependencyHandler=function(e,t,n){a[e]&&@warn(`Bot\x20dependency\x20handler[${e}]\x20has\x20been\x20overwritten`),a[e]={name:e,tester:t,sync:n}},t!==o&&(e.exports=t)},c["brush\x2ejs"]=function(e,t,n,s,i,o){const r=n("url"),x=[],c=[],a=function(e){x.push(e)};a(e=>{let t=r.parse(e.repo);if("proj:"!==t.protocol)return;let n=void 0;switch(t.host){case"\x2e":n=@path(bot.cwd,t.pathname.slice(1));break;case"\x2e\x2e":n=@path(bot.cwd,"\x2e\x2e",t.pathname.slice(1));break;default:throw new Error(`Invalid\x20proj\x20repository[${e.repo}]`)}e.repo=r.pathToFileURL(@.fs.posixOSPath(n)).href}),e.exports.registerRepoBrush=function(e,t){x.push(n=>{n.repo===e&&(n.repo=t)})},e.exports.registerRefishBrush=function(e,t,n){x.unshift(s=>{let i=s.refish;i||(i="master"),s.repo===e&&i===t&&(s.refish=n)})},e.exports.registerCommandBrush=function(e,t){1!==arguments.length?c.push(n=>{if(e.length===n.length){for(let t=0;t<e.length;++t)if(e[t]!==n[t])return;n.length=0;for(let e=0;e<t.length;++e)n[e]=t[e]}}):c.push(e)},e.exports.registerDepBrush=a,e.exports.brushDep=function(e){for(let t of x)t(e)},e.exports.brushCommand=function(e){for(let t of c)t(e)},t!==o&&(e.exports=t)},c["cmd\x2fbrush\x2ejs"]=function(e,t,n,s,i,o){const r=n("url");e.exports.command=function(e){let t=e.commands[0],n=['@import\x28"mew\x2ebot"\x29;',""];if(e.options.repo){let s=e.options.repo.split("\x2c")[0],i=e.options.repo.split("\x2c")[1];@info(`Writing\x20brush\x20repository[${s}]\x20=>\x20${i}`),n.push(`@bot\x2ebrush\x2erepo\x28${JSON.stringify({from:s,to:i},null,4)}\x29;`),n.push(""),t="repo_"+@.fs.basename(r.parse(e.options.repo.split(";")[0]).pathname)}if(e.options.refish){let s=e.options.repo.split("\x2c")[0],i=e.options.repo.split("\x2c")[1],o=e.options.repo.split("\x2c")[2];@info(`Writing\x20brush\x20re\x66ish[${s};${i}]\x20=>\x20${o}`),n.push(`@bot\x2ebrush\x2ere\x66ish\x28${JSON.stringify({repo:s,from:i,to:o},null,4)}\x29;`),n.push(""),t||(t="re\x66ish_"+@.fs.basename(r.parse(e.options.repo.split(";")[0]).pathname)+"_"+e.options.repo.split(";")[1].split(":")[0])}if(e.options.cmd){let s=witches.options.cmd.split("\x2c")[0],i=witches.options.cmd.split("\x2c")[1];@info(`Writing\x20brush\x20command[${s}]\x20=>\x20${i}`),n.push(`@bot\x2ebrush\x2ecmd\x28${JSON.stringify({from:s,to:i},null,4)}\x29;`),n.push(""),t||(t="cmd_"+e.options.cmd.split(";")[0])}let s=@path(process.cwd(),"bot\x2fbrushes",t+"\x2ejs");return@.fs.exists.file(s)&&(@error(`Brush[${t}]\x20\x66ile\x20already\x20e\x78ists\x2c\x20use\x20another\x20id\x20i\x66\x20not\x20duplicated`),process.exit(1)),@.fs.writeFile(s,n.join("\n")).then(function(){@celebr(`Brush[${t}]\x20has\x20been\x20generated\x20at\x20${s}`),process.exit(0)})},t!==o&&(e.exports=t)},c["cmd\x2fcheck\x2ejs"]=function(e,t,n,s,i,o){const r=n("\x2e\x2e\x2fbot\x2ejs");e.exports.command=function(e){let t=e.commands[0];t||(t="de\x66ault");let n=process.cwd(),s=@.merge.simple(process.env,e.settings.env),i=new r.MewBot(t,e.options,n,s,{buildPath:e.settings.buildPath,cachePath:e.settings.cachePath,noCache:e.settings.noCache,noSync:e.settings.noSync,noDeps:e.settings.noDeps});return@.async(function(){i.checkSignature().catch(this)}).then(function(e,n){e&&(@error(e),process.exit(1)),n?@info(`Bot[${t}]\x20has\x20new\x20changes`):@info(`Bot[${t}]\x20has\x20no\x20changes\x20a\x66ter\x20last\x20build`),process.exit(0)})},t!==o&&(e.exports=t)},c["cmd\x2fe\x78ec\x2ejs"]=function(e,t,n,s,i,o){const r=n("\x2e\x2e\x2fbot\x2ejs");e.exports.command=function(e){let t=e.commands[0];t||(t="de\x66ault");let s=process.cwd(),i=@.merge.simple(process.env,e.settings.env);if(e.settings.brushes)for(let t of e.settings.brushes)n(@path(process.cwd(),t));let o=new r.MewBot(t,e.options,s,i,{buildPath:e.settings.buildPath,cachePath:e.settings.cachePath,noCache:e.settings.noCache,noSync:e.settings.noSync,noDeps:e.settings.noDeps,noGlobalBrush:e.settings.noGlobalBrush,brushes:e.settings.brushes});return o.ready.then(function(){o.resolved.dependencies.pipe(this)}).then(function(t,n){e.settings.noDeps?o.lock(()=>@.async(function(){o.options.noCache?this.next(!0):o.checkSignature().pipe(this)}).then(function(e){e?o.buildWithoutDependencies(t,n,{}).pipe(this):this.next()})).pipe(this):o.buildWithDependencies(t,n,{}).pipe(this)}).finished(e=>{e&&(@error(e),process.exit(1)),process.exit(0)})},t!==o&&(e.exports=t)},c["cmd\x2fhelp\x2ejs"]=function(e,t,n,s,i,o){const{switchesRules:r,abbreviations:x}=n("\x2e\x2e\x2fhelp\x2ejs"),c=n("\x2e\x2e\x2fbot\x2ejs");e.exports.command=function(e){let t=e.commands[0],n=process.cwd(),s=@.merge.simple(process.env,e.settings.env);t||(t="de\x66ault",@.fs.exists.file(n,"bot",t+"\x2ejs")||(@.task.printHelp(r,x),process.exit(0))),@.fs.exists.file(n,"bot",t+"\x2ejs")||(@error(`Bot[${t}]\x20not\x20\x66ound\x20at\x20${n}`),process.exit(1));let i=new c.MewBot(t,e.options,n,s,{});@.task.printHelp(@.merge({},r,{options:i.config.vars},{"\x21taskHelp":{prefix:i.config.help}}),x),process.exit(0)},t!==o&&(e.exports=t)},c["cmd\x2flist\x2ejs"]=function(e,t,n,s,i,o){n("\x2e\x2e\x2fbot\x2ejs");const r=function(e,t,n){if((e+="").length>=t)return@.term.text(e,n);for(;e.length<t;)e+="\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20";return@.term.text(e.slice(0,t),n)};e.exports.command=function(e){const t=process.cwd();let s=[];@.fs.exists.dir(@path(t,"bot"))&&(s=@.fs.listFiles(@path(t,"bot")).filter(e=>"\x66ile"===e.type&&"\x2ejs"===@.fs.extname(e.name))),process.stdout.write(`\nBots\x20provided\x20at\x20${@.term.text(t,"green")}\n\n`),s.length>0?(process.stdout.write(`\x20${r("NAME",16)}\x20DESCRIPTION\n`),process.stdout.write("\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\x2d\n"),s.forEach(e=>{let s=void 0,i=!1;try{s=n(@path(t,"bot",e.name))}catch(e){i=e}i?process.stdout.write("\x20"+r(@.fs.basename(e.name),16,"red")+"\x20"+@.term.text(i.message,"white")+"\n"):s&&s.build||s.dists||s.deps?s.help?process.stdout.write("\x20"+r(@.fs.basename(e.name),16,"yellow")+"\x20"+@.term.text(s.help,"white")+"\n"):process.stdout.write("\x20"+r(@.fs.basename(e.name),16,"yellow")+"\n"):process.stdout.write("\x20"+r(@.fs.basename(e.name),16,"red")+"\x20"+@.term.text("<empty\x20bot>","white")+"\n")}),s.length>1?process.stdout.write(`\nThere\x20are\x20${@.term.text(s.length+"","cyan")}\x20bots\x20available\n\n`):process.stdout.write(`\nThere\x20is\x20only\x20${@.term.text(s.length+"","cyan")}\x20bot\x20available\n\n`)):process.stdout.write(`There\x20is\x20${@.term.text("no","cyan")}\x20bot\x20available\n\n`),process.exit(0)},t!==o&&(e.exports=t)},c["dep\x2fbot\x2ejs"]=function(e,t,n,s,i,o){@import("js\x2ezip");const r=n("url");e.exports.name="bot",e.exports.tester=function(e,t,n,s){let i=r.parse(e.repo);return("http:"===i.protocol||"https:"===i.protocol)&&"\x2ebot"===@.fs.extname(i.pathname)},e.exports.syncer=function(e,t,n,s,i,o,o,x,c){let a=r.parse(e.repo).pathname,p=this.resolveDependencyPath(e),h=this.resolveDependencyID(e),l=@path(p,"bot\x2esig"),d=this.resolveBuildPath(e),u=this.resolveDistPath(e),f=!1,b=c?10:void 0,m=!1;if(!i[e.repo]||o&&i[e.repo].version!==o){if(p===a)i[e.repo]=@.async.resolve(p,!1,!1,new Date);else{let t=i[e.repo],n=void 0;t&&(n=@.async.result(t));let s=@.net.httpClient();i[e.repo]=@.async(function(){@.fs.makeDirs(@.fs.dirname(p)),@.fs.exists.dir(p)&&x?this.next(void 0,p,!0,!1):@.lock.write(@path(p,"repo\x2erwlck"),b,()=>{m=!0;let t=void 0,n=void 0,i=@path(d,"bot\x2dsign\x2ejson"),o=void 0;return@.async(function(){@debug(`Fetching\x20bot[${h}]`),s.request(e.repo,{dataType:"json",onSuccess:this.next,onError:this.reject})}).then(function(x){x.dist?(o=@.hash.sha1(JSON.stringify(x)),@.async(function(){@.fs.readFile(i,"json").catch(this)}).then(function(c,a){!c&&a&&a.hash===o&&@.fs.exists(l)?this.next():(f=!0,@.async(function(){n=x;let i=r.parse(e.repo);i.pathname=x.dist.file;let o=r.format(i);t=@path(d,@.fs.filename(x.dist.file)),@.fs.makeDirs(@.fs.dirname(t)),@debug(`Downloading\x20bot[${h}]`),s.download(o,t,{deleteFileIfExists:!0,onError:this.reject,onSuccess:this.next})}).then(function(){@.fs.deleteFile(u).pipe(this)}).then(function(){@.fs.makeDirs(u),@debug(`E\x78tracting\x20bot\x20dist[${h}]`),@zip.load(t).then(function(e){e.extractAll(u).pipe(this)}).pipe(this)}).then(function(){@.fs.writeFile(i,JSON.stringify({signature:n,hash:o},null,4)).pipe(this)}).then(function(){@.fs.writeFile(l,o).pipe(this)}).pipe(this))}).pipe(this)):this.next()}).then(function(){this.next(p,!1,f)})}).catch(this)}).then(function(e,n,s,i){if(e&&@error(e),!m&&t)return@debug(`Synchronization\x20o\x66\x20dependency[${h}]\x20skipped\x20\x66or\x20related\x20bot\x20not\x20\x66inished`),void t.pipe(this);e?this.reject(e):(@info(`Dependency[${h}]\x20has\x20been\x20synchronized\x20to\x20latest\x20locked\x20version`),this.next(n,s,i,new Date))}),n&&(i[e.repo].lastSynchronized=n[3])}return i[e.repo].localPath=p,i[e.repo].version=o,i[e.repo]}return i[e.repo].then(function(e,t,n,s){this.next(e,t,!1,s)})},t!==o&&(e.exports=t)},c["dep\x2f\x66ile\x2ejs"]=function(e,t,n,s,i,o){n("crypto");const r=n("url");e.exports.name="\x66ile",e.exports.tester=function(e,t,n,s){let i=r.parse(e.repo);return"\x66ile:"===i.protocol&&"\x2egit"!==@.fs.extname(i.pathname)},e.exports.syncer=function(e,t,n,s,i,o,o,x,c){let a=r.parse(e.repo),p=@path(a.pathname),h=this.resolveDependencyPath(e),l=this.resolveDependencyID(e),d=c?10:void 0,u=!1;if(!i[e.repo]||o&&i[e.repo].version!==o){if(h===p)i[e.repo]=@.async.resolve(h,!1,!1,new Date);else{let t=i[e.repo],n=void 0;t&&(n=@.async.result(t)),i[e.repo]=@.async(function(){@.fs.exists.dir(h)&&x?this.next(void 0,h,!1,!1):@.lock.write(@path(h,"repo\x2erwlck"),d,()=>(u=!0,@.async(function(){@.fs.exists(h)?"link"!==@.fs.fileLStats(h).type?@.fs.deleteFile(h).pipe(this):@.fs.readLink(h)!==p?@.fs.deleteFile(h).pipe(this):this.next():this.next()}).then(function(){let e=void 0;try{e=@.fs.readLink(h)}catch(e){}e!==p&&@.fs.linkFile(p,h,"dir"),this.next(h,!1,!1)}))).catch(this)}).then(function(e,n,s,i){if(!u&&t)return@debug(`Synchronization\x20o\x66\x20dependency[${l}]\x20skipped\x20\x66or\x20related\x20bot\x20not\x20\x66inished`),void t.pipe(this);e?this.reject(e):(@info(`Dependency[${l}]\x20has\x20been\x20synchronized\x20to\x20latest\x20locked\x20version`),this.next(n,s,i,new Date))}),n&&(i[e.repo].lastSynchronized=n[3])}return i[e.repo].localPath=h,i[e.repo].version=o,i[e.repo]}return i[e.repo].then(function(e,t,n,s){this.next(e,t,!1,s)})},t!==o&&(e.exports=t)},c["dep\x2fgit\x2ejs"]=function(e,t,n,s,i,o){n("crypto");const r=n("url");@import("js\x2egit");e.exports.name="git",e.exports.tester=function(e,t,n,s){let i=r.parse(e.repo);return"git:"===i.protocol||("http:"===i.protocol||"https:"===i.protocol||"ssh:"===i.protocol||"proj:"===i.protocol||"\x66ile:"===i.protocol)&&"\x2egit"===@.fs.extname(i.pathname)},e.exports.syncer=function(e,t,n,s,i,o,o,r,x){let c=this.resolveDependencyPath(e),a=this.resolveDependencyID(e),p=@path(this.resolveDependencyRepoPath(e),"repo\x2egit"),h=!1,l=void 0,d=x?10:void 0,u=!1;if(!i[e.repo]||o&&i[e.repo].version!==o){let t=i[e.repo],n=void 0;t&&(n=@.async.result(t));let s=!1;i[e.repo]=@.async(function(){@.fs.makeDirs(@.fs.dirname(p));let t=@path(p,"\x2e\x2e\x2frepo\x2erwlck");@.fs.exists.dir(p)&&r?this.next():@.lock.write(t,d,()=>(s=!0,@.async(function(){@.fs.exists.dir(p)?(@debug(`Synchronizing\x20repository[${e.repo}]`),@git.fetch(p,"origin",{refspec:["\x2bre\x66s\x2fheads\x2f\x2a:re\x66s\x2fheads\x2f\x2a","\x2bre\x66s\x2ftags\x2f\x2a:re\x66s\x2ftags\x2f\x2a"]}).pipe(this)):(@debug(`Synchronizing\x20repository[${e.repo}]`),h=!0,@git.clone(e.repo,p,{bare:!0}).then(function(e){e.close().pipe(this)}).pipe(this))}))).catch(this)}).then(function(n){if(!s&&t)return r||@debug(`Synchronization\x20o\x66\x20repository[${e.repo}]\x20skipped\x20\x66or\x20related\x20bot\x20not\x20\x66inished`),void t.pipe(this);n?this.reject(n):(@info(`Repository[${e.repo}]\x20has\x20been\x20synchronized\x20to\x20latest\x20version`),this.next(p,!1,!1,new Date))}),n&&(i[e.repo].lastSynchronized=n[3]),i[e.repo].localPath=p,i[e.repo].version=o}let f="dep:\x2f\x2flocalhost"+@.fs.posixOSPath(c);if(!i[f]||o&&i[f].version!==o){let t=i[f],n=void 0;t&&(n=@.async.result(t));let s=void 0;return i[f]=i[e.repo].then(function(t,n,i,o){r&&@.fs.exists.dir(@path(c,"\x2egit"))?this.next(void 0,c,!1,!1):(s=o,@.lock.write(@path(c,"repo\x2erwlck"),d,()=>(u=!0,@.async(function(){@.fs.makeDirs(@path(c,"\x2e\x2e")),@.fs.exists.dir(@path(c,"\x2egit"))?(@debug(`Synchronizing\x20dependency[${a}]`),@git.fetch(c,"origin").pipe(this)):(@debug(`Synchronizing\x20dependency[${a}]`),h=!0,@git.clone(p,c).then(function(e){e.close().pipe(this)}).pipe(this))}).then(function(){@git.status(c).then(function(e){l=e.lastCommitID,this.next()}).pipe(this)}).then(function(){let t=e.refish;t||(t="origin\x2fmaster");let n=void 0;@git.resolveRefish(p,t).then(function(e){(n=e)!==l?(h=!0,@git.reset(c,n).pipe(this)):this.next()}).pipe(this)}).then(function(){this.next(c,!1,h)}))).catch(this))}).then(function(e,n,i,o){if(!u&&t)return@debug(`Synchronization\x20o\x66\x20dependency[${a}]\x20skipped\x20\x66or\x20related\x20bot\x20not\x20\x66inished`),void t.pipe(this);e?this.reject(e):(@info(`Dependency[${a}]\x20has\x20been\x20synchronized\x20to\x20latest\x20locked\x20version`),this.next(n,i,o,s))}),n&&(i[f].lastSynchronized=n[3]),i[f].localPath=c,i[f].version=o,i[f]}return i[f].then(function(e,t,n,s){this.next(e,t,!1,s)})},t!==o&&(e.exports=t)},c["dep\x2fjson\x2ejs"]=function(e,t,n,s,i,o){@import("js\x2ezip");const r=n("url");e.exports.name="bot",e.exports.tester=function(e,t,n,s){let i=r.parse(e.repo);if("http:"===i.protocol||"https:"===i.protocol)return"\x2ejson"===@.fs.extname(i.pathname);return!1},e.exports.syncer=function(e,t,n,s,i,o,o,x,c){let a=r.parse(e.repo).pathname,p=this.resolveDependencyPath(e),h=this.resolveDependencyID(e),l=@path(p,"bot\x2esig"),d=this.resolveBuildPath(e),u=this.resolveDistPath(e),f=!1,b=c?10:void 0,m=!1;if(!i[e.repo]||o&&i[e.repo].version!==o){if(p===a)i[e.repo]=@.async.resolve(p,!1,!1,new Date);else{let t=i[e.repo],n=void 0;t&&(n=@.async.result(t));let s=@.net.httpClient();i[e.repo]=@.async(function(){@.fs.makeDirs(@.fs.dirname(p)),@.fs.exists.dir(p)&&x?this.next(void 0,p,!0,!1):@.lock.write(@path(p,"repo\x2erwlck"),b,()=>{m=!0;let t=@path(d,"bot\x2dsign\x2ejson"),n=void 0;return@.async(function(){@debug(`Fetching\x20bot[${h}]`),s.request(`${e.repo}?timestamp=${Date.now()}`,{dataType:"json",onSuccess:this.next,onError:this.reject})}).then(function(e){n=@.hash.sha1(JSON.stringify(e)),@.async(function(){@.fs.readFile(t,"json").catch(this)}).then(function(s,i){!s&&i&&i.hash===n&&@.fs.exists(l)?this.next():(f=!0,@.async(function(){@.fs.makeDirs(u),@.fs.writeFile(@path(u,"download\x2ejson"),JSON.stringify(e,null,4)).pipe(this)}).then(function(){@.fs.makeDirs(@.fs.dirname(t)),@.fs.writeFile(t,JSON.stringify({signature:e,hash:n},null,4)).pipe(this)}).then(function(){@.fs.makeDirs(@.fs.dirname(l)),@.fs.writeFile(l,n).pipe(this)}).pipe(this))}).pipe(this)}).then(function(){this.next(p,!1,f)})}).catch(this)}).then(function(e,n,s,i){if(e&&@error(e),!m&&t)return@debug(`Synchronization\x20o\x66\x20dependency[${h}]\x20skipped\x20\x66or\x20related\x20bot\x20not\x20\x66inished`),void t.pipe(this);e?this.reject(e):(@info(`Dependency[${h}]\x20has\x20been\x20synchronized\x20to\x20latest\x20locked\x20version`),this.next(n,s,i,new Date))}),n&&(i[e.repo].lastSynchronized=n[3])}return i[e.repo].localPath=p,i[e.repo].version=o,i[e.repo]}return i[e.repo].then(function(e,t,n,s){this.next(e,t,!1,s)})},t!==o&&(e.exports=t)},c["help\x2ejs"]=function(e,t,n,s,i,o){e.exports.switchesRules={"\x21programName":"mew_bot","\x21de\x66aultTaskMode":"start","\x21taskModes":{brush:"brush",start:"start",check:"check",list:"list",help:"help",version:"version"},"\x21taskHelp":{prefix:"Program\x20mew_bot\x20targets\x20to\x20help\x20mew_js\x20users\x20to\x20write\x20\ntools\x20with\x20more\x20\x66le\x78ibilities",modes:{brush:{text:"Create\x20brush\x20\x66ile\x20\x66or\x20bots",command:"mew_bot\x20brush\x20[<id>]"},check:{text:"Check\x20mew_bot\x20signatures",command:"mew_bot\x20check\x20[<bot>]"},start:{text:"Start\x20a\x20mew_bot\x20shell",command:"mew_bot\x20start\x20[<bot>]"},list:{text:"List\x20all\x20available\x20bots\x20in\x20current\x20working\x20directory",command:"mew_bot\x20list"},help:"Print\x20help\x20te\x78t",version:"Report\x20mew_bot\x20version"},suffix:"More\x20in\x66o\x20is\x20available\x20at\x20https:\x2f\x2fwww\x2emewchan\x2ecom",examples:[{command:"mew_bot\x20start\x20\x78\x78\x78\x20\x2d\x2dno\x2ddeps",text:"Start\x20bot\x20using\x20con\x66igs\x20in\x20`bot\x2f\x78\x78\x78\x2ejs`\x20\nwithout\x20checking\x20depedencies"},{command:"mew_bot\x20\x78\x78\x78\x20\x2d\x2dhelp",text:"Print\x20bot\x20in\x66os\x20in\x20`bot\x2f\x78\x78\x78\x2ejs`"}]},options:{repo:{"\x21valueType":"string","\x21switchTe\x78t":"Repository\x20\x66or\x20brush\x2c\x20\x66ormat\x20as\x20`\x66rom_url;to_url`"},refish:{"\x21valueType":"string","\x21switchTe\x78t":"Repository\x20re\x66ish\x20\x66or\x20brush\x2c\x20\x66ormat\x20as\x20\n`repo_url;\x66rom_re\x66ish;to_re\x66ish`"},cmd:{"\x21valueType":"string","\x21switchTe\x78t":"Command\x20brush\x2c\x20\x66ormat\x20as\x20`\x66rom_cmd;to_cmd`"}},settings:{debug:{"\x21valueType":"boolean","\x21de\x66aultValue":!1,"\x21switchTe\x78t":"Force\x20to\x20run\x20in\x20debug\x20mode"},buildPath:{"\x21valueType":"string","\x21switchTe\x78t":"Build\x20path\x20\x66or\x20mew_bot\x20to\x20run"},cachePath:{"\x21valueType":"string","\x21switchTe\x78t":"Cache\x20path\x20\x66or\x20mew_bot\x20to\x20run\x20\x28server\x20used\x29"},noSync:{"\x21valueType":"boolean","\x21de\x66aultValue":!1,"\x21switchTe\x78t":"Ignore\x20sync\x20i\x66\x20already\x20e\x78ists"},noDeps:{"\x21valueType":"boolean","\x21de\x66aultValue":!1,"\x21switchTe\x78t":"Ignore\x20checks\x20\x66or\x20depedencies"},noCache:{"\x21valueType":"boolean","\x21de\x66aultValue":!1,"\x21switchTe\x78t":"Force\x20to\x20e\x78ecute\x20bot\x20without\x20caches"},brushes:{"\x21valueType":"array","\x21switchTe\x78t":"Brush\x20\x66iles\x20\x66or\x20bot\x20e\x78ecution","\x21arrayElement":{"\x21valueType":"string"}},noGlobalBrush:{"\x21valueType":"boolean","\x21switchTe\x78t":"No\x20global\x20brushes"},pipeInternalOutput:{"\x21valueType":"boolean","\x21de\x66aultValue":!1,"\x21switchTe\x78t":"Pipe\x20internal\x20e\x78ecution\x20output"},help:{"\x21valueType":"boolean","\x21de\x66aultValue":!1,"\x21switchTe\x78t":"Force\x20to\x20print\x20help\x20te\x78t"},version:{"\x21valueType":"boolean","\x21de\x66aultValue":!1,"\x21switchTe\x78t":"Force\x20to\x20print\x20mew_chan\x20version\x20te\x78t"}}},e.exports.abbreviations=[],t!==o&&(e.exports=t)},c["mod\x2ejs"]=function(e,t,n,s,i,o){n("\x2e\x2fannot\x2ejs"),e.exports=n("\x2e\x2fbot\x2ejs"),t!==o&&(e.exports=t)},c["proc\x2ejs"]=function(e,t,n,s,i,o){const r=n("child_process");e.exports.spawnProcess=function(e,t,n,s,i){const o=function(e,t,n,s){let i=@.task.resolve.shebang(e,n,s);return{command:i[0],switches:i.slice(1).concat(t)}}(e,t,n,s),x={cwd:n||process.cwd(),env:Object.assign({},process.env,s),windowsHide:!0};return@.async(function(){var t=r.spawn(o.command,o.switches,x);let n=!1;const s=e=>{n||t.stdin.write(e)};process.stdin.on("data",s),t.stdout.on("data",e=>{i?i("stdout",e):process.stdout.write(e)}),t.stderr.on("data",e=>{i?i("stderr",e):process.stderr.write(e)}),t.on("close",(t,i)=>{n=!0,process.stdin.off("data",s),t||i?this.reject(new Error(`Failed\x20to\x20e\x78ecute[${e}]:\x20e\x78it\x20code\x20${t}`)):this.next()})})},t!==o&&(e.exports=t)},module.exports=y("\x2e\x2finde\x78\x2ejs")}();